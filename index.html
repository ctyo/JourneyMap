<!DOCTYPE html>
<html>
<head>
<title>JourneyMap</title>
<meta charset="utf-8">
<meta name="description" content="import gpx route data on map.">
<meta name="author" content="https://twitter.com/c_tyo">
<style>
html, body {
  margin:0;
  padding:0;
  width: 100%;
  height: 100%;
}
.popup {
  position:fixed;
  width: 100%;
  height: 100%;
  background: #000;
  z-index: 100;
  transition: .2s ease;
  opacity: 0.8;
}
.popwindow {
  top:40%;
  left:25%;
  background: #eaeaea;
  width: 50%;
  height: 20%;

  display: inline-block;
  position: relative;
  padding: 1em 2.2em;
  text-align: center;
  color: #fff;
  border-radius: 10px;
  background-color: #2772DB;
  overflow: hidden;
}
.popwindow .label{
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translateY(-50%) translateX(-50%);
  font-size: 200%;
}
.popwindow input{
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  opacity: 0;
  cursor: pointer;
}

#original_controll {
  position: absolute;
  top: 30px;
  right: 7px;
  z-index:2;
  text-align:right;
}

#capture {
  font-size: 35px;
}

#map {
  height: 100%;
  width: 100%;
  z-index: 1;
}

#progress {
  position: fixed;
  z-index: 3;
  width: 100%;
  height: 2px;
  -webkit-appearance: none;
  vertical-align: 1em;
  color:red;
}
#progress[value] {color:red} /* IE10 */
#progress::-webkit-progress-bar-value {background:red}
#progress::-webkit-progress-value {background:red}
#progress::-moz-progress-bar {background:red}


</style>
</head>
<body>
<progress id="progress" value="0" max="100"></progress>
<div class="popup"><div class="popwindow">
<div class="label">Select Gpx Files</div>
<input type="file" id="files" name="files[]" accept=".gpx" multiple />
</div></div>
<div id="original_controll">
<div id="capture">📷</div>
<a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-text="今まで走った記録を残しました" data-url="https://ctyo.github.io/JourneyMap/" data-hashtags="JourneyMap " data-show-count="false">Tweet</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</div>
<div id="map"></div>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://maps.google.com/maps/api/js?v=3&key=【key】&sensor=false" type="text/javascript" charset="UTF-8"></script>
<script src="http://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<script>
(function () {
var files = [];
var files_length = 0;
var opts = {
  zoom: 5,
  mapTypeId: google.maps.MapTypeId.ROADMAP,
  center: new google.maps.LatLng(39, 138),
  styles: [{
    stylers: [
      {gamma: 0},
      {lightness: 0},
      {saturation: -60},
      {inverse_lightness: false}
    ]
  }]
};

map = new google.maps.Map(document.getElementById("map"), opts);
bounds = new google.maps.LatLngBounds();


function parse_gpx (xml_string) {
  var route = [];

  var parser = new DOMParser();
  var xmldoc = parser.parseFromString(xml_string, "text/xml");
  $(xmldoc).find('trk>trkseg>trkpt').each(function (i, pt) {
    if (i%2 !== 0) return;
    var $pt = $(pt);
    var latlon = new google.maps.LatLng($pt.attr('lat'),$pt.attr('lon'));
    route.push(latlon);
    bounds.extend (latlon);
  });

  var polylineOpts = {
    map: map,
    path: route,
    strokeColor: 'red',
    strokeOpacity: 0.7,
    strokeWeight: 2
  };
  var polyline = new google.maps.Polyline(polylineOpts);



}


var reader = new FileReader();
function readFiles (files_array) {
  if (files_array.length > 0) {
    var file = files_array.shift();

    // プログレスバー、背景色の更新
    var progress = (files_length - files_array.length) / files_length;
    $('#progress').attr({'value':progress*100});
    $('.popup').css({'opacity': 0.7-progress});

    reader.onloadend = function (loadEvent) {
      parse_gpx(loadEvent.target.result);
      readFiles(files_array);
    }
    reader.readAsText(file);
  } else {
    map.fitBounds(bounds)
    // プログレスバー等の削除
    $('#progress').hide();
    $('.popup').hide();
  }
}

// 画像を保存
$('#capture').on('click', function () {
    // コントロールを消す
    map.setOptions({disableDefaultUI:true});
    $('#original_controll').hide();

    var capture = function () {
      html2canvas(document.querySelector("#map"),{
        useCORS: true
      }).then(function(canvas) {
        // コントロールを復活
        map.setOptions({disableDefaultUI:false});
        $('#original_controll').show();
  
        var base64 = canvas.toDataURL('image/png');
        var blob = Base64toBlob(base64);
        saveBlob(blob, 'journeymap.png');
       });
    }
    setTimeout(capture ,50);
});

$('#files').on('change', function (e) {
  var file_array = [];
  $(e.target.files).each(function (i, file) {
    file_array.push(file);
  });
  files_length = file_array.length;
  readFiles(file_array);
});


// Base64データをBlobデータに変換
function Base64toBlob(base64)
{
    // カンマで分割して以下のようにデータを分ける
    // tmp[0] : データ形式（data:image/png;base64）
    // tmp[1] : base64データ（iVBORw0k～）
    var tmp = base64.split(',');
    // base64データの文字列をデコード
    var data = atob(tmp[1]);
    // tmp[0]の文字列（data:image/png;base64）からコンテンツタイプ（image/png）部分を取得
    var mime= tmp[0].split(':')[1].split(';')[0];   //  1文字ごとにUTF-16コードを表す 0から65535 の整数を取得
    var buf = new Uint8Array(data.length);
    for (var i = 0; i < data.length; i++) {
      buf[i] = data.charCodeAt(i);
    }
    var blob = new Blob([buf], { type: mime });
    return blob;
}
 
// 画像のダウンロード
function saveBlob(blob, fileName)
{
    var url = (window.URL || window.webkitURL);
    // ダウンロード用のURL作成
    var dataUrl = url.createObjectURL(blob);
    // イベント作成
    var event = document.createEvent("MouseEvents");
    event.initMouseEvent("click", true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
    // a要素を作成
    var a = document.createElementNS("http://www.w3.org/1999/xhtml", "a");
    // ダウンロード用のURLセット
    a.href = dataUrl;
    // ファイル名セット
    a.download = fileName;
    // イベントの発火
    a.dispatchEvent(event);
}

})();
</script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-11027566-8', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>

